<!DOCTYPE html>
<html>
<head>
    <title>Spotify Premium Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #191414; color: white; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #1db954; border-radius: 5px; background: #282828; }
        .error { border-color: #ff6b6b; background: #3d1a1a; }
        .success { border-color: #1db954; background: #1a3d1a; }
        pre { background: #121212; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { 
            background: #1db954; color: white; border: none; padding: 10px 20px; 
            border-radius: 25px; cursor: pointer; margin: 5px;
        }
        button:hover { background: #1ed760; }
        .disabled { background: #535353; cursor: not-allowed; }
        .disabled:hover { background: #535353; }
    </style>
</head>
<body>
    <h1>ðŸŽµ Spotify Premium Diagnostic Tool</h1>
    
    <div class="test">
        <h3>Step 1: Get Access Token</h3>
        <button onclick="loginToSpotify()" id="loginBtn">Login to Spotify</button>
        <div id="tokenResult"></div>
    </div>
    
    <div class="test">
        <h3>Step 2: Check Account Status</h3>
        <button onclick="checkPremium()" id="premiumBtn" class="disabled" disabled>Check Premium Status</button>
        <div id="premiumResult"></div>
    </div>
    
    <div class="test">
        <h3>Step 3: Test Web Playback SDK</h3>
        <button onclick="testPlayer()" id="playerBtn" class="disabled" disabled>Test Player</button>
        <div id="playerResult"></div>
    </div>
    
    <div class="test">
        <h3>Step 4: Test Playback</h3>
        <button onclick="testPlayback()" id="playBtn" class="disabled" disabled>Test Playback</button>
        <div id="playbackResult"></div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        let accessToken = null;
        let player = null;
        let deviceId = null;
        
        function log(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre class="${isError ? 'error' : 'success'}">${content}</pre>`;
        }
        
        function enableButton(buttonId) {
            const btn = document.getElementById(buttonId);
            btn.disabled = false;
            btn.classList.remove('disabled');
        }
        
        async function loginToSpotify() {
            try {
                window.location.href = 'http://127.0.0.1:3000/login';
            } catch (error) {
                log('tokenResult', 'Error redirecting to login: ' + error.message, true);
            }
        }
        
        async function checkPremium() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }
                
                const user = await response.json();
                log('premiumResult', JSON.stringify({
                    id: user.id,
                    display_name: user.display_name,
                    product: user.product,
                    country: user.country,
                    is_premium: user.product === 'premium'
                }, null, 2));
                
                if (user.product === 'premium') {
                    enableButton('playerBtn');
                } else {
                    log('premiumResult', 'ERROR: Account is not Premium! Current product: ' + user.product, true);
                }
            } catch (error) {
                log('premiumResult', 'Error checking premium status: ' + error.message, true);
            }
        }
        
        window.onSpotifyWebPlaybackSDKReady = () => {
            console.log('Spotify SDK Ready');
        };
        
        async function testPlayer() {
            try {
                if (!window.Spotify) {
                    throw new Error('Spotify SDK not loaded');
                }
                
                player = new window.Spotify.Player({
                    name: 'Premium Test Player',
                    getOAuthToken: cb => cb(accessToken),
                    volume: 0.5
                });
                
                player.addListener('ready', ({ device_id }) => {
                    console.log('Player ready with device ID:', device_id);
                    deviceId = device_id;
                    log('playerResult', `Player ready! Device ID: ${device_id}`);
                    enableButton('playBtn');
                });
                
                player.addListener('not_ready', ({ device_id }) => {
                    log('playerResult', `Player not ready. Device ID: ${device_id}`, true);
                });
                
                player.addListener('initialization_error', ({ message }) => {
                    log('playerResult', `Initialization error: ${message}`, true);
                });
                
                player.addListener('authentication_error', ({ message }) => {
                    log('playerResult', `Authentication error: ${message}`, true);
                });
                
                player.addListener('account_error', ({ message }) => {
                    log('playerResult', `Account error: ${message}`, true);
                });
                
                const connected = await player.connect();
                if (!connected) {
                    throw new Error('Failed to connect player');
                }
                
                log('playerResult', 'Player connecting... waiting for ready event');
                
            } catch (error) {
                log('playerResult', 'Error setting up player: ' + error.message, true);
            }
        }
        
        async function testPlayback() {
            try {
                if (!deviceId) {
                    throw new Error('No device ID available');
                }
                
                // First try to get available devices
                const devicesResponse = await fetch('https://api.spotify.com/v1/me/player/devices', {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });
                
                if (devicesResponse.ok) {
                    const devices = await devicesResponse.json();
                    log('playbackResult', 'Available devices: ' + JSON.stringify(devices, null, 2));
                }
                
                // Try to transfer playback
                const transferResponse = await fetch('https://api.spotify.com/v1/me/player', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        device_ids: [deviceId],
                        play: false
                    })
                });
                
                if (!transferResponse.ok && transferResponse.status !== 404) {
                    const error = await transferResponse.json();
                    throw new Error(`Transfer failed: ${JSON.stringify(error)}`);
                }
                
                // Wait a bit for transfer
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Try to start playback with a specific track (Spotify's test track)
                const playResponse = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: ['spotify:track:4iV5W9uYEdYUVa79Axb7Rh'] // Spotify test track
                    })
                });
                
                if (!playResponse.ok) {
                    const errorText = await playResponse.text();
                    let errorJson;
                    try {
                        errorJson = JSON.parse(errorText);
                    } catch {
                        errorJson = { message: errorText };
                    }
                    throw new Error(`Playback failed (${playResponse.status}): ${JSON.stringify(errorJson, null, 2)}`);
                }
                
                log('playbackResult', 'âœ… Playback started successfully!');
                
            } catch (error) {
                log('playbackResult', 'Playback test failed: ' + error.message, true);
            }
        }
        
        // Check for tokens in URL (from OAuth callback)
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('access_token');
            
            if (token) {
                accessToken = token;
                log('tokenResult', 'âœ… Access token received: ' + token.substring(0, 20) + '...');
                enableButton('premiumBtn');
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>