<!DOCTYPE html>
<html>
<head>
    <title>Spotify App Diagnostics</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 3px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Spotify App Diagnostics</h1>
    
    <div id="results"></div>
    
    <button onclick="runDiagnostics()">Run Full Diagnostics</button>
    <button onclick="testCredentials()">Test Credentials Only</button>
    
    <script>
        const CLIENT_ID = 'fface556f117426f9693f47601acfa60';
        const BACKEND_URL = 'http://127.0.0.1:3000';
        
        function addResult(title, status, message, details = '') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            resultsDiv.appendChild(div);
        }
        
        async function testCredentials() {
            document.getElementById('results').innerHTML = '';
            
            try {
                // Test client credentials flow
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(CLIENT_ID + ':5f285173367e469fac9f0f75ba7ea25d')
                    },
                    body: 'grant_type=client_credentials'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult('Credentials Test', 'success', 'Spotify credentials are valid', 
                        `Access token received: ${data.access_token.substring(0, 20)}...`);
                } else {
                    const error = await response.text();
                    addResult('Credentials Test', 'error', 'Invalid credentials', error);
                }
            } catch (error) {
                addResult('Credentials Test', 'error', 'Failed to test credentials', error.message);
            }
        }
        
        async function runDiagnostics() {
            document.getElementById('results').innerHTML = '';
            
            // Test 1: Backend connectivity
            try {
                const response = await fetch(BACKEND_URL + '/debug');
                if (response.ok) {
                    const data = await response.json();
                    addResult('Backend Connection', 'success', 'Backend is running', JSON.stringify(data, null, 2));
                } else {
                    addResult('Backend Connection', 'error', 'Backend returned error', `Status: ${response.status}`);
                }
            } catch (error) {
                addResult('Backend Connection', 'error', 'Cannot connect to backend', error.message);
            }
            
            // Test 2: Credentials
            await testCredentials();
            
            // Test 3: Spotify Web Playback SDK
            if (window.Spotify) {
                addResult('Spotify SDK', 'success', 'Spotify Web Playback SDK is loaded', 'SDK is available in window');
            } else {
                addResult('Spotify SDK', 'warning', 'Spotify Web Playback SDK not loaded', 
                    'This may be normal if not on the main app page');
            }
            
            // Test 4: Check if we're on HTTPS or localhost
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            if (isSecure) {
                addResult('Security Context', 'success', 'Running in secure context', 
                    `Protocol: ${location.protocol}, Host: ${location.hostname}`);
            } else {
                addResult('Security Context', 'error', 'Not in secure context', 
                    'Spotify Web Playback SDK requires HTTPS or localhost');
            }
            
            // Test 5: CORS check
            try {
                const response = await fetch(BACKEND_URL + '/', { mode: 'cors' });
                if (response.ok) {
                    addResult('CORS Configuration', 'success', 'CORS is properly configured', 'Cross-origin requests working');
                } else {
                    addResult('CORS Configuration', 'warning', 'CORS may have issues', `Status: ${response.status}`);
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    addResult('CORS Configuration', 'error', 'CORS blocking requests', error.message);
                } else {
                    addResult('CORS Configuration', 'warning', 'Could not test CORS', error.message);
                }
            }
        }
    </script>
</body>
</html>